# Copyright Bruno Dutra 2017
# Distributed under the Boost Software License, Version 1.0.
# See accompanying file LICENSE.txt or copy at http://boost.org/LICENSE_1_0.txt

sudo: required
language: cpp

git:
    depth: 1

env:
    global:
      - secure: "juqIG3Tfvas+ohx+o2KM6O4YnayNyye+w591fGJsE2uNkjBivIHntyFqZakdVeE8phsRAjChDD7YThYuIHblp8sAz0ydBJf2MOfJ77PH19I+2svg3skXOBNf6UtzQtAB5cvq/t4CXHeAgJjFLfNdYt2irc2nISGw+IpSz8CpS7hxdAluyTFJob/mhbz7AcRzYwZyuj0d3qTELL5TaL2SZ6WMgnTMaxhLdbh0wlhsFD1kkpzQsCajifmIK0z84CYk7tNBOvy5xPdZHIBvwzmXcL56QHAexJrKooyhkPDRu6jzexCTmd5t4PFDTVSHEzSulrOtUKd2PxrZxAjsJ3o75G8p7Mh3/F6UEhcGzcx05MIPWS7T3SDZAVxwLSLpW7PAivQQAMtTzwo5AyVbAU1uHnvN/59oldcI53CNWnviADEscA52n3r5/5UHuyJ02q4viGIzV1kV1dtVcPx7Lp8VIlzLhCPs7IsGw+Vlrt9KLF9GssW7NqnBWZsuQdwGPQMs9fV8CePFB1LJZMxC0ybAeL18+fSuvgGjGSp3lqMbLyBh9sPCrLVdPriYRV+6pvGdtb6mMgs3W9KQEM9wYZGsuzqrBh5bovQ7YMb80SqRCeb4WFCaj7jkMCkvPQBOuQ+obKYtqD1teJzOiYcPP7IwBlhVqK9lxeQGCCa2SHdRjaw="
      - VERSION=7

addons:
    apt:
        packages: &pkgs
          - tree
          - g++-7
          - clang-5.0
          - clang-format-5.0
        sources: &srcs
          - ubuntu-toolchain-r-test
          - llvm-toolchain-trusty-5.0

matrix:
    include:
      - os: linux
        dist: trusty
        env: DEPLOY=true

      - os: linux
        dist: trusty
        env: CHECK_FORMATTING=/usr/bin/clang-format-5.0

      - os: linux
        dist: trusty
        compiler: g++
        env: VERSION=7 CXXFLAGS="-fsanitize=address,leak,undefined -fuse-ld=gold"

      - os: linux
        dist: trusty
        compiler: clang++
        env: VERSION=5.0 CXXFLAGS="-fsanitize=address,leak,undefined"

before_install:
  - git config --global user.name "Travis Bot"
  - git config --global user.email "\<\>"

  - SOURCE_PATH="${TRAVIS_BUILD_DIR}"

  - BUILD_PATH="${TRAVIS_BUILD_DIR}/build"
  - mkdir -p "${BUILD_PATH}"

  - INSTALL_PATH="${TRAVIS_BUILD_DIR}/install"
  - mkdir -p "${INSTALL_PATH}"

  - DEPS_PATH="${TRAVIS_BUILD_DIR}/deps"
  - mkdir -p "${DEPS_PATH}"

  - GITHUB_PATH="${TRAVIS_BUILD_DIR}/github"
  - mkdir -p "${GITHUB_PATH}"

  - |
    if [[ -n "${VERSION}" ]]
    then
        export CC="${CC}-${VERSION}"
        export CXX="${CXX}-${VERSION}"
    fi

  - |
    function publish {
        git clone https://brunocodutra:${GITHUB_TOKEN}@github.com/brunocodutra/alloy -q --depth 1 --branch=$2 "${GITHUB_PATH}/$2" &> /dev/null || return 1
        cp -r "${GITHUB_PATH}/$2/.git/" $1                                                                                        &> /dev/null || return 2
        git -C $1 add --all .                                                                                                     &> /dev/null || return 3
        git -C $1 commit --allow-empty -m "update to $(git -C ${SOURCE_PATH} rev-parse --short HEAD)"                             &> /dev/null || return 4
        git -C $1 push origin $2                                                                                                  &> /dev/null || return 5
    }

install:
  - |
    if [[ "${TRAVIS_OS_NAME}" == "linux" ]]
    then
        CMAKE_URL="http://www.cmake.org/files/v3.8/cmake-3.8.0-Linux-x86_64.tar.gz"
        mkdir -p "${DEPS_PATH}/cmake" || exit $?
        travis_retry curl -L "${CMAKE_URL}" | tar --strip-components=1 -xz -C "${DEPS_PATH}/cmake" || exit $?
        export PATH=${DEPS_PATH}/cmake/bin:${PATH}
    fi

  - |
    if [[ ${CC} == clang* ]] && [[ ${CXX} == clang++* ]]
    then
        git clone --depth 1 http://llvm.org/git/llvm.git "${DEPS_PATH}/llvm" || exit $?
        git clone --depth 1 http://llvm.org/git/libcxx.git "${DEPS_PATH}/llvm/projects/libcxx" || exit $?
        git clone --depth 1 http://llvm.org/git/libcxxabi.git "${DEPS_PATH}/llvm/projects/libcxxabi" || exit $?

        LLVM_CMAKE_ARGS+=(-H"${DEPS_PATH}/llvm")
        LLVM_CMAKE_ARGS+=(-B"${DEPS_PATH}/llvm/build")
        LLVM_CMAKE_ARGS+=(-DCMAKE_INSTALL_PREFIX="${DEPS_PATH}/llvm/install")
        LLVM_CMAKE_ARGS+=(-DLLVM_USE_SANITIZER="Undefined;Address")

        CXXFLAGS="" LDFLAGS="" cmake ${LLVM_CMAKE_ARGS[@]} || exit $?
        make -C "${DEPS_PATH}/llvm/build" -j install-cxx install-cxxabi || exit $?

        export CXXFLAGS="${CXXFLAGS} -stdlib=libc++ -nostdinc++ -isystem ${DEPS_PATH}/llvm/install/include/c++/v1"
        export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${DEPS_PATH}/llvm/install/lib"
        export LDFLAGS="${LDFLAGS} -L${DEPS_PATH}/llvm/install/lib"
    fi

before_script:
  - CMAKE_ARGS+=("-H${SOURCE_PATH}")
  - CMAKE_ARGS+=("-B${BUILD_PATH}")
  - CMAKE_ARGS+=("-DCMAKE_INSTALL_PREFIX=${INSTALL_PATH}")

  - |
    if [[ -n "${CHECK_FORMATTING}" ]]
    then
        CMAKE_ARGS+=("-DCLANG_FORMAT=${CHECK_FORMATTING}")
    fi

  - cmake ${CMAKE_ARGS[@]}

script:
  - |
    if [[ "${DEPLOY}" == "true" ]]
    then
        cmake --build "${BUILD_PATH}" --target install || exit $?
        tree "${INSTALL_PATH}" || exit $?
        if [[ "${TRAVIS_BRANCH}" == "master" && "${TRAVIS_PULL_REQUEST}" == "false" ]]
        then
            publish "${INSTALL_PATH}/include/" standalone || exit $?
        fi
    elif [[ -n "${CHECK_FORMATTING}" ]]
    then
        (cd "${BUILD_PATH}" && ctest --output-on-failure -R ^test.format)
    else
        (cd "${BUILD_PATH}" && ctest --output-on-failure -E ^test.format)
    fi

notifications:
  webhooks:
    urls: https://webhooks.gitter.im/e/f6f076c43196d662f905
    on_success: change
    on_failure: always
